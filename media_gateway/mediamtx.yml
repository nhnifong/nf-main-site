# configuration for MediaMTX server to forward video for Stringman Robots

###############################################
# General
###############################################

# Webrtc must be served over https in production build
# however, these keys would not be found on the local build and that is a fatal error.
webrtcEncryption: ${WEBRTC_USE_HTTPS}
webrtcServerKey: /https/privkey.pem
webrtcServerCert: /https/fullchain.pem

# inform mediamtx of it's public hostname
webrtcAdditionalHosts: ${WEBRTC_ADDITIONAL_HOSTS}

# Authentication
# We use http authentication to delegate permissions to the control_plane
# This sends a POST request to the configured URL with the stream credentials
authMethod: http
authHTTPAddress: ${CONTROL_PLANE_API_URL}/internal/auth

###############################################
# Paths (Routing Logic)
###############################################
paths:
  # Private Robot Streams
  # e.g., stringman/b5823f8e-0e49-4251-93f1-0bd978124883/2
  ~^stringman/.*:
    # Just a straight pipe. No transcoding.
    # WebRTC is enabled by default in MediaMTX.
    runOnReady: ""

  # The Playroom (Public Broadcast)
  # This specific path triggers HLS transcoding for the spectators.
  playroom:
    # When a robot publishes to 'playroom', start ffmpeg to chop it into HLS segments
    # Note: $RTSP_PORT and $G1 are internal MediaMTX variables, do not touch them.
    runOnReady: >
      ffmpeg -i rtsp://localhost:$RTSP_PORT/$G1
      -c:v copy -an
      -f hls
      -hls_time 4
      -hls_list_size 5
      -hls_flags delete_segments
      /hls_storage/stream.m3u8
    
    # Clean up when the robot disconnects
    runOnReadRestart: yes
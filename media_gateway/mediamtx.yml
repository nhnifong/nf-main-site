# configuration for MediaMTX server to forward video for Stringman Robots

# Authentication
# We use http authentication to delegate permissions to the control_plane
# This sends a POST request to the configured URL with the stream credentials
authMethod: http
authHTTPAddress: http://172.17.0.1:8080/internal/auth

# Paths (Routing Logic)
paths:
  # 1. Private Robot Streams (Default)
  # Uses regex (~) to match any path starting with 'robot_'
  # e.g., rtmp://server/robot_99
  ~^robot_.*:
    # Just a straight pipe. No transcoding.
    # WebRTC is enabled by default in MediaMTX.
    runOnReady: ""

  # 2. The Playroom (Public Broadcast)
  # This specific path triggers HLS transcoding for the spectators.
  playroom:
    # When a robot publishes to 'playroom', start ffmpeg to chop it into HLS segments
    # We output to /hls_storage which will be a mounted volume
    runOnReady: >
      ffmpeg -i rtsp://localhost:$RTSP_PORT/$G1
      -c:v copy -c:a copy
      -f hls
      -hls_time 4
      -hls_list_size 5
      -hls_flags delete_segments
      /hls_storage/stream.m3u8
    
    # Clean up when the robot disconnects
    runOnReadRestart: yes